<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker é•œåƒåŠ é€Ÿå™¨æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .results {
            display: grid;
            gap: 15px;
        }

        .result-item {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .result-item.available {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .result-item.unavailable {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-url {
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }

        .result-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .result-status.available {
            background: #28a745;
            color: white;
        }

        .result-status.unavailable {
            background: #dc3545;
            color: white;
        }

        .result-details {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #666;
            flex-wrap: wrap;
        }

        .result-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .mirror-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
            font-family: monospace;
        }

        .mirror-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .info-text {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .guide-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .guide-section h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guide-section h3 {
            color: #555;
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .guide-section ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .guide-section li {
            margin-bottom: 8px;
            color: #666;
            line-height: 1.6;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
            line-height: 1.5;
        }

        .code-block code {
            color: #f8f8f2;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .recommended-config {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .recommended-config h3 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .recommended-config pre {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        .copy-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #138496;
        }

        .tips {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ³ Docker é•œåƒåŠ é€Ÿå™¨æµ‹è¯•å·¥å…·</h1>
        <p class="subtitle">æ£€æµ‹é•œåƒåŠ é€Ÿå™¨æ˜¯å¦å¯ç”¨ï¼Œè‡ªåŠ¨æµ‹è¯•å“åº”æ—¶é—´å’ŒçŠ¶æ€</p>

        <!-- æŒ‡å—åŒºåŸŸ -->
        <div class="guide-section">
            <h2>ğŸ“– ä½¿ç”¨æŒ‡å—</h2>
            
            <h3>å¦‚ä½•éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ</h3>
            <p style="color: #666; margin-bottom: 10px;">é…ç½®å®Œæˆåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ Docker é…ç½®ï¼š</p>
            <div class="code-block">
<code>docker info | grep -i registry</code>
            </div>
            <p style="color: #666; margin-bottom: 10px;">å¦‚æœçœ‹åˆ°é…ç½®çš„é•œåƒæºåœ°å€ï¼Œè¯´æ˜é…ç½®æˆåŠŸã€‚ç„¶åå¯ä»¥æµ‹è¯•æ‹‰å–é•œåƒï¼š</p>
            <div class="code-block">
<code>docker pull library/alpine:latest</code>
            </div>

            <h3>å¦‚ä½•é€‰æ‹©æœ€ä½³é•œåƒæº</h3>
            <ul>
                <li><strong>æŸ¥çœ‹ç›‘æ§çŠ¶æ€ï¼š</strong>åœ¨é¦–é¡µæŸ¥çœ‹å„ä¸ªé•œåƒæºçš„å®æ—¶çŠ¶æ€</li>
                <li><strong>ä¼˜å…ˆé€‰æ‹©åœ¨çº¿çŠ¶æ€ï¼š</strong>é€‰æ‹©çŠ¶æ€ä¸º <span style="color: #28a745; font-weight: bold;">å¯ç”¨</span> çš„é•œåƒæº</li>
                <li><strong>é¿å…ç¦»çº¿æºï¼š</strong>é¿å…ä½¿ç”¨çŠ¶æ€ä¸º <span style="color: #dc3545; font-weight: bold;">ä¸å¯ç”¨</span> çš„é•œåƒæº</li>
                <li><strong>å“åº”æ—¶é—´è€ƒè™‘ï¼š</strong>ä¼˜å…ˆé€‰æ‹©å“åº”æ—¶é—´è¾ƒçŸ­çš„é•œåƒæºï¼ˆé€šå¸¸ < 500msï¼‰</li>
                <li><strong>å¤šæºé…ç½®ï¼š</strong>å»ºè®®é…ç½® 3-5 ä¸ªé•œåƒæºä½œä¸ºå¤‡é€‰ï¼ŒDocker ä¼šè‡ªåŠ¨é€‰æ‹©æœ€å¿«çš„</li>
            </ul>

            <div class="tips">
                ğŸ’¡ <strong>æç¤ºï¼š</strong>ç³»ç»Ÿæ¯ 1 å°æ—¶è‡ªåŠ¨æ£€æµ‹ä¸€æ¬¡å„ä¸ªé•œåƒæºçš„çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®æ€§ï¼ŒåŒæ—¶é¿å…å¯¹é•œåƒæºé€ æˆè¿‡å¤§å‹åŠ›ã€‚é¡µé¢åŠ è½½æ—¶ä¼šè‡ªåŠ¨ä»ç›‘æ§æ•°æ®ä¸­è·å–å½“å‰åœ¨çº¿çš„é•œåƒæºï¼Œå¹¶æ›´æ–° Docker çš„é…ç½®ç¤ºä¾‹ï¼Œç¡®ä¿æ‚¨è·å¾—æœ€æ–°å¯ç”¨çš„é•œåƒæºé…ç½®ã€‚ç‚¹å‡»"åˆ·æ–°çŠ¶æ€"å¯æ‰‹åŠ¨æ›´æ–°ã€‚
            </div>

            <!-- è‡ªåŠ¨æ›´æ–°çš„é…ç½®ç¤ºä¾‹ -->
            <div id="autoConfigSection" style="margin-top: 20px; display: none; background: #e7f3ff; padding: 15px; border-radius: 6px; border-left: 4px solid #17a2b8;">
                <h3 style="color: #0c5460; margin-bottom: 10px;">ğŸ”„ æœ€æ–°å¯ç”¨é…ç½®ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰</h3>
                <p style="color: #004085; margin-bottom: 10px; font-size: 13px;">
                    ä»¥ä¸‹æ˜¯æ ¹æ®å½“å‰æµ‹è¯•ç»“æœè‡ªåŠ¨ç”Ÿæˆçš„æœ€æ–°é…ç½®ï¼ŒåŒ…å«å“åº”æ—¶é—´æœ€å¿«çš„å¯ç”¨é•œåƒæºï¼š
                </p>
                <div class="code-block" id="autoConfigCode" style="background: #2d2d2d; color: #f8f8f2; border: 1px solid #dee2e6;">
                    <code id="autoConfigContent" style="color: #f8f8f2;">æ­£åœ¨æ£€æµ‹ä¸­...</code>
                </div>
                <button class="copy-btn" onclick="copyAutoConfig()" id="copyAutoConfigBtn" style="display: none; margin-top: 10px;">ğŸ“‹ å¤åˆ¶é…ç½®</button>
                <p style="color: #004085; margin-top: 10px; font-size: 12px;">
                    <span id="configUpdateTime"></span>
                </p>
            </div>
        </div>

        <div class="controls">
            <button class="btn-primary" onclick="refreshResults()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            <button class="btn-info" onclick="showRecommendedConfig()">æ¨èé…ç½®</button>
            <button class="btn-success" onclick="exportResults()">å¯¼å‡ºç»“æœ</button>
        </div>

        <div id="recommendedConfig" class="recommended-config"></div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="stats" id="stats" style="display: flex;">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">æ€»è®¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statAvailable" style="color: #28a745;">0</div>
                <div class="stat-label">å¯ç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statUnavailable" style="color: #dc3545;">0</div>
                <div class="stat-label">ä¸å¯ç”¨</div>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentResults = [];

        // é»˜è®¤é•œåƒç«™åˆ—è¡¨
        const defaultMirrors = [
            "https://docker.1ms.run",
            "https://docker.1panel.live",
            "https://docker.m.ixdev.cn",
            "https://hub.rat.dev",
            "https://docker.xuanyuan.me",
            "https://dockerproxy.net",
            "https://docker.hlmirror.com",
            "https://hub1.nat.tf",
            "https://hub2.nat.tf",
            "https://hub3.nat.tf",
            "https://hub4.nat.tf",
            "https://docker.m.daocloud.io",
            "https://docker.kejilion.pro",
            "https://hub.1panel.dev",
            "https://dockerproxy.cool",
            "https://proxy.vvvv.ee",
            "https://dockerproxy.com",
            "https://docker.mirrors.ustc.edu.cn",
            "https://docker.nju.edu.cn"
        ];

        async function refreshResults() {
            const resultsDiv = document.getElementById('results');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const statsDiv = document.getElementById('stats');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨åˆ·æ–°é•œåƒç«™çŠ¶æ€...</div>';
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            statsDiv.style.display = 'none';

            // ç¦ç”¨æŒ‰é’®
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            try {
                // å…ˆæ›´æ–°é…ç½®ï¼ˆä» API è·å–æœ€æ–°ï¼‰
                await updateAutoConfigFromAPI();
                
                // å…ˆå°è¯•è·å–ç¼“å­˜
                const cachedData = await getCachedResults();
                
                if (cachedData && cachedData.results && cachedData.results.length > 0) {
                    // ä½¿ç”¨ç¼“å­˜ç»“æœ
                    currentResults = cachedData.results;
                    
                    // æ˜¾ç¤ºç»Ÿè®¡
                    updateStats({
                        total: cachedData.total,
                        available: cachedData.available,
                        unavailable: cachedData.unavailable
                    });
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayResults(currentResults);
                } else {
                    // æ²¡æœ‰ç¼“å­˜ï¼Œæ‰§è¡Œå®æ—¶æµ‹è¯•
                    const response = await fetch(`${API_BASE}/api/test/all`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            mirrors: defaultMirrors
                        })
                    });

                    const data = await response.json();
                    currentResults = data.results || [];

                    // æ˜¾ç¤ºç»Ÿè®¡
                    updateStats(data);

                    // æ˜¾ç¤ºç»“æœ
                    displayResults(currentResults);

                    // è‡ªåŠ¨æ›´æ–°é…ç½®ç¤ºä¾‹ï¼ˆå®æ—¶æ£€æµ‹ç»“æœï¼‰
                    updateAutoConfig(currentResults);
                }

                // æ›´æ–°è¿›åº¦
                progressFill.style.width = '100%';

            } catch (error) {
                resultsDiv.innerHTML = `<div class="loading" style="color: #dc3545;">åˆ·æ–°å¤±è´¥: ${error.message}</div>`;
            } finally {
                // æ¢å¤æŒ‰é’®
                buttons.forEach(btn => btn.disabled = false);
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 500);
            }
        }

        function updateStats(data) {
            const statsDiv = document.getElementById('stats');
            document.getElementById('statTotal').textContent = data.total || 0;
            document.getElementById('statAvailable').textContent = data.available || 0;
            document.getElementById('statUnavailable').textContent = data.unavailable || 0;
            statsDiv.style.display = 'flex';
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="loading">æ²¡æœ‰æµ‹è¯•ç»“æœ</div>';
                return;
            }

            let html = '<div class="results">';
            
            results.forEach(result => {
                const statusClass = result.available ? 'available' : 'unavailable';
                const statusText = result.available ? 'âœ“ å¯ç”¨' : 'âœ— ä¸å¯ç”¨';
                const statusCode = result.status_code || 'N/A';
                const responseTime = result.response_time || 0;
                const testTime = result.test_time || '';

                html += `
                    <div class="result-item ${statusClass}">
                        <div class="result-header">
                            <div class="result-url">${result.mirror}</div>
                            <div class="result-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="result-details">
                            <div class="result-detail">
                                <strong>çŠ¶æ€:</strong> ${result.status}
                            </div>
                            <div class="result-detail">
                                <strong>HTTP:</strong> ${statusCode}
                            </div>
                            <div class="result-detail">
                                <strong>å“åº”æ—¶é—´:</strong> ${responseTime}ms
                            </div>
                            <div class="result-detail">
                                <strong>æµ‹è¯•æ—¶é—´:</strong> ${testTime}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // ç§»é™¤ clearResults å‡½æ•°ï¼Œä¸å†éœ€è¦

        function showRecommendedConfig() {
            if (currentResults.length === 0) {
                alert('è¯·å…ˆè¿›è¡Œæµ‹è¯•ï¼Œè·å–æµ‹è¯•ç»“æœåå†æŸ¥çœ‹æ¨èé…ç½®');
                return;
            }

            const available = currentResults.filter(r => r.available);
            
            if (available.length === 0) {
                alert('æ²¡æœ‰å¯ç”¨çš„é•œåƒæºï¼Œæ— æ³•ç”Ÿæˆæ¨èé…ç½®');
                return;
            }

            // æŒ‰å“åº”æ—¶é—´æ’åºï¼Œé€‰æ‹©æœ€å¿«çš„ 3-5 ä¸ª
            const sorted = available.sort((a, b) => a.response_time - b.response_time);
            const recommended = sorted.slice(0, Math.min(5, sorted.length));

            const config = {
                "registry-mirrors": recommended.map(r => r.mirror)
            };

            const configDiv = document.getElementById('recommendedConfig');
            configDiv.style.display = 'block';
            configDiv.innerHTML = `
                <h3>âœ¨ æ¨èé…ç½®ï¼ˆå“åº”æ—¶é—´æœ€å¿«çš„ ${recommended.length} ä¸ªé•œåƒæºï¼‰</h3>
                <p style="color: #666; margin-bottom: 10px; font-size: 13px;">
                    ä»¥ä¸‹æ˜¯æ ¹æ®æµ‹è¯•ç»“æœæ¨èçš„é•œåƒæºé…ç½®ï¼ŒæŒ‰å“åº”æ—¶é—´ä»å¿«åˆ°æ…¢æ’åºï¼š
                </p>
                <div style="margin-bottom: 10px;">
                    ${recommended.map((r, i) => 
                        `<div style="padding: 5px 0; color: #555; font-size: 13px;">
                            ${i + 1}. ${r.mirror} <span style="color: #28a745;">(${r.response_time}ms)</span>
                        </div>`
                    ).join('')}
                </div>
                <p style="color: #666; margin-bottom: 10px; font-size: 13px;"><strong>é…ç½®å†…å®¹ (daemon.json):</strong></p>
                <pre>${JSON.stringify(config, null, 2)}</pre>
                <button class="copy-btn" onclick="copyConfig()">ğŸ“‹ å¤åˆ¶é…ç½®</button>
                <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 12px; color: #004085;">
                    <strong>é…ç½®æ­¥éª¤ï¼š</strong><br>
                    1. å¤åˆ¶ä¸Šé¢çš„é…ç½®å†…å®¹<br>
                    2. ç¼–è¾‘ <code>/etc/docker/daemon.json</code> æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰<br>
                    3. å°†é…ç½®å†…å®¹ç²˜è´´åˆ°æ–‡ä»¶ä¸­<br>
                    4. è¿è¡Œ <code>sudo systemctl daemon-reload</code><br>
                    5. è¿è¡Œ <code>sudo systemctl restart docker</code><br>
                    6. è¿è¡Œ <code>docker info | grep -i registry</code> éªŒè¯é…ç½®
                </div>
            `;

            // æ»šåŠ¨åˆ°æ¨èé…ç½®åŒºåŸŸ
            configDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function copyConfig() {
            const available = currentResults.filter(r => r.available);
            const sorted = available.sort((a, b) => a.response_time - b.response_time);
            const recommended = sorted.slice(0, Math.min(5, sorted.length));
            
            const config = {
                "registry-mirrors": recommended.map(r => r.mirror)
            };
            
            const configText = JSON.stringify(config, null, 2);
            
            navigator.clipboard.writeText(configText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ å·²å¤åˆ¶';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#17a2b8';
                }, 2000);
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é…ç½®å†…å®¹');
            });
        }

        function exportResults() {
            if (currentResults.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœï¼Œè¯·å…ˆè¿›è¡Œæµ‹è¯•');
                return;
            }

            const available = currentResults.filter(r => r.available);
            const unavailable = currentResults.filter(r => !r.available);

            let text = '=== Docker é•œåƒåŠ é€Ÿå™¨æµ‹è¯•ç»“æœ ===\n\n';
            text += `æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n`;
            text += `æ€»è®¡: ${currentResults.length} | å¯ç”¨: ${available.length} | ä¸å¯ç”¨: ${unavailable.length}\n\n`;

            text += '=== å¯ç”¨çš„é•œåƒç«™ ===\n';
            available.forEach(r => {
                text += `${r.mirror} (${r.status}, ${r.response_time}ms)\n`;
            });

            text += '\n=== ä¸å¯ç”¨çš„é•œåƒç«™ ===\n';
            unavailable.forEach(r => {
                text += `${r.mirror} (${r.status})\n`;
            });

            // ç”Ÿæˆå¯ç”¨çš„é…ç½® JSON
            text += '\n=== å¯ç”¨çš„é…ç½® (daemon.json) ===\n';
            const config = {
                "registry-mirrors": available.map(r => r.mirror)
            };
            text += JSON.stringify(config, null, 2);

            // ç”Ÿæˆæ¨èé…ç½®
            const sorted = available.sort((a, b) => a.response_time - b.response_time);
            const recommended = sorted.slice(0, Math.min(5, sorted.length));
            text += '\n\n=== æ¨èé…ç½®ï¼ˆå“åº”æ—¶é—´æœ€å¿«çš„ ' + recommended.length + ' ä¸ªï¼‰===\n';
            const recommendedConfig = {
                "registry-mirrors": recommended.map(r => r.mirror)
            };
            text += JSON.stringify(recommendedConfig, null, 2);

            text += '\n\n=== é…ç½®æ­¥éª¤ ===\n';
            text += '1. ç¼–è¾‘ /etc/docker/daemon.json æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰\n';
            text += '2. å°†é…ç½®å†…å®¹ç²˜è´´åˆ°æ–‡ä»¶ä¸­\n';
            text += '3. è¿è¡Œ: sudo systemctl daemon-reload\n';
            text += '4. è¿è¡Œ: sudo systemctl restart docker\n';
            text += '5. éªŒè¯é…ç½®: docker info | grep -i registry\n';
            text += '6. æµ‹è¯•æ‹‰å–: docker pull library/alpine:latest\n';

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `docker-mirrors-test-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function updateAutoConfigFromAPI() {
            try {
                const response = await fetch(`${API_BASE}/api/config/recommended`);
                const data = await response.json();
                
                if (data.config) {
                    const configText = JSON.stringify(data.config, null, 2);
                    document.getElementById('autoConfigContent').textContent = configText;
                    document.getElementById('autoConfigSection').style.display = 'block';
                    document.getElementById('copyAutoConfigBtn').style.display = 'inline-block';
                    
                    let updateInfo = `æœ€åæ£€æµ‹: <strong>${data.last_update || 'æœªçŸ¥'}</strong>`;
                    if (data.next_update) {
                        updateInfo += ` | ä¸‹æ¬¡æ£€æµ‹: <strong>${data.next_update}</strong>`;
                    }
                    updateInfo += ` | å¯ç”¨é•œåƒæº: <strong>${data.total_available}</strong> ä¸ª | æ¨èä½¿ç”¨: <strong>${data.count}</strong> ä¸ª`;
                    updateInfo += ` | æ•°æ®æ¥æº: å®šæ—¶æ£€æµ‹ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰`;
                    document.getElementById('configUpdateTime').innerHTML = updateInfo;
                } else {
                    document.getElementById('autoConfigContent').textContent = data.error || 'æš‚æ— å¯ç”¨çš„é•œåƒæº';
                    document.getElementById('autoConfigSection').style.display = 'block';
                    document.getElementById('copyAutoConfigBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('è·å–æ¨èé…ç½®å¤±è´¥:', error);
            }
        }

        function updateAutoConfig(results) {
            const available = results.filter(r => r.available);
            
            if (available.length === 0) {
                document.getElementById('autoConfigContent').textContent = 'æš‚æ— å¯ç”¨çš„é•œåƒæº';
                document.getElementById('autoConfigSection').style.display = 'block';
                document.getElementById('copyAutoConfigBtn').style.display = 'none';
                document.getElementById('configUpdateTime').textContent = 'æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN') + ' | æœªæ‰¾åˆ°å¯ç”¨çš„é•œåƒæº';
                return;
            }

            // æŒ‰å“åº”æ—¶é—´æ’åºï¼Œé€‰æ‹©æœ€å¿«çš„ 5 ä¸ª
            const sorted = available.sort((a, b) => a.response_time - b.response_time);
            const recommended = sorted.slice(0, Math.min(5, sorted.length));

            const config = {
                "registry-mirrors": recommended.map(r => r.mirror)
            };

            const configText = JSON.stringify(config, null, 2);
            document.getElementById('autoConfigContent').textContent = configText;
            document.getElementById('autoConfigSection').style.display = 'block';
            document.getElementById('copyAutoConfigBtn').style.display = 'inline-block';
            
            const updateTime = new Date().toLocaleString('zh-CN');
            const avgResponseTime = Math.round(recommended.reduce((sum, r) => sum + r.response_time, 0) / recommended.length);
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ›´æ–°ä¿¡æ¯ï¼ˆæ¥è‡ªç¼“å­˜ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ›´æ–°
            const existingInfo = document.getElementById('configUpdateTime').textContent;
            if (!existingInfo || existingInfo.includes('æ­£åœ¨') || existingInfo.includes('æ£€æµ‹ä¸­')) {
                document.getElementById('configUpdateTime').innerHTML = 
                    `æœ€åæ›´æ–°: <strong>${updateTime}</strong> | å¯ç”¨é•œåƒæº: <strong>${available.length}</strong> ä¸ª | æ¨èä½¿ç”¨: <strong>${recommended.length}</strong> ä¸ªï¼ˆå¹³å‡å“åº”æ—¶é—´: <strong>${avgResponseTime}ms</strong>ï¼‰ | æ•°æ®æ¥æº: å®æ—¶æ£€æµ‹`;
            }
        }

        function copyAutoConfig() {
            const configContent = document.getElementById('autoConfigContent').textContent;
            
            if (configContent === 'æ­£åœ¨æ£€æµ‹ä¸­...' || configContent === 'æš‚æ— å¯ç”¨çš„é•œåƒæº') {
                alert('æš‚æ— é…ç½®å¯å¤åˆ¶ï¼Œè¯·ç­‰å¾…æµ‹è¯•å®Œæˆ');
                return;
            }
            
            navigator.clipboard.writeText(configContent).then(() => {
                const btn = document.getElementById('copyAutoConfigBtn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ å·²å¤åˆ¶';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#17a2b8';
                }, 2000);
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é…ç½®å†…å®¹');
            });
        }

        // è·å–ç¼“å­˜çš„æµ‹è¯•ç»“æœ
        async function getCachedResults() {
            try {
                const response = await fetch(`${API_BASE}/api/test/cached`);
                const data = await response.json();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®
                if (data.results && data.results.length > 0) {
                    return data;
                }
            } catch (error) {
                console.log('è·å–ç¼“å­˜å¤±è´¥ï¼Œå°†æ‰§è¡Œå®æ—¶æµ‹è¯•:', error);
            }
            return null;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºçŠ¶æ€
        window.addEventListener('load', async () => {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const autoConfigSection = document.getElementById('autoConfigSection');
            autoConfigSection.style.display = 'block';
            document.getElementById('autoConfigContent').textContent = 'æ­£åœ¨ä»ç›‘æ§æ•°æ®ä¸­è·å–æœ€æ–°é…ç½®...';
            document.getElementById('configUpdateTime').textContent = 'æ­£åœ¨ä»ç›‘æ§æ•°æ®ä¸­è·å–æœ€æ–°çŠ¶æ€...';
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨åŠ è½½é•œåƒæºçŠ¶æ€...</div>';
            
            // å…ˆå°è¯•ä» API è·å–æ¨èé…ç½®ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
            await updateAutoConfigFromAPI();
            
            // å…ˆå°è¯•è·å–ç¼“å­˜ç»“æœ
            const cachedData = await getCachedResults();
            
            if (cachedData && cachedData.results && cachedData.results.length > 0) {
                // ä½¿ç”¨ç¼“å­˜ç»“æœ
                currentResults = cachedData.results;
                
                // æ˜¾ç¤ºç»Ÿè®¡
                updateStats({
                    total: cachedData.total,
                    available: cachedData.available,
                    unavailable: cachedData.unavailable
                });
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(currentResults);
            } else {
                // æ²¡æœ‰ç¼“å­˜ï¼Œæ‰§è¡Œå®æ—¶æµ‹è¯•
                document.getElementById('configUpdateTime').textContent = 'æ­£åœ¨æ‰§è¡Œå®æ—¶æ£€æµ‹...';
                resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨æ‰§è¡Œå®æ—¶æ£€æµ‹...</div>';
                
                try {
                    const response = await fetch(`${API_BASE}/api/test/all`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            mirrors: defaultMirrors
                        })
                    });

                    const data = await response.json();
                    currentResults = data.results || [];

                    // æ˜¾ç¤ºç»Ÿè®¡
                    updateStats(data);

                    // æ˜¾ç¤ºç»“æœ
                    displayResults(currentResults);

                    // è‡ªåŠ¨æ›´æ–°é…ç½®ç¤ºä¾‹
                    updateAutoConfig(currentResults);
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="loading" style="color: #dc3545;">æ£€æµ‹å¤±è´¥: ${error.message}</div>`;
                }
            }
        });
    </script>
</body>
</html>

